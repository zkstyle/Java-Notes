# ConcurrentHashMap & Hashtableå¯¹æ¯”
> 16æ˜¯2çš„å¹‚ï¼Œ8ä¹Ÿæ˜¯ï¼Œ32ä¹Ÿæ˜¯ï¼Œä¸ºå•¥ååé€‰äº†16ï¼Ÿ

ç”¨16åªæ˜¯å› ä¸ºä½œè€…è®¤ä¸º16è¿™ä¸ªåˆå§‹å®¹é‡æ˜¯èƒ½ç¬¦åˆå¸¸ç”¨è€Œå·²ã€‚åªè¦æ˜¯2æ¬¡å¹‚ï¼Œå…¶å®ç”¨ 8 å’Œ 32 éƒ½å·®ä¸å¤š

> Hashmapä¸­çš„é“¾è¡¨å¤§å°è¶…è¿‡å…«ä¸ªæ—¶ä¼šè‡ªåŠ¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘ï¼Œå½“åˆ é™¤å°äºå…­æ—¶é‡æ–°å˜ä¸ºé“¾è¡¨ï¼Œä¸ºå•¥å‘¢ï¼Ÿ

æ ¹æ®æ³Šæ¾åˆ†å¸ƒï¼Œåœ¨è´Ÿè½½å› å­é»˜è®¤ä¸º0.75çš„æ—¶å€™ï¼Œå•ä¸ªhashæ§½å†…å…ƒç´ ä¸ªæ•°ä¸º8çš„æ¦‚ç‡å°äºç™¾ä¸‡åˆ†ä¹‹ä¸€ï¼Œæ‰€ä»¥å°†7ä½œä¸ºä¸€ä¸ªåˆ†æ°´å²­ï¼Œç­‰äº7çš„æ—¶å€™ä¸è½¬æ¢ï¼Œå¤§äºç­‰äº8çš„æ—¶å€™æ‰è¿›è¡Œè½¬æ¢ï¼Œå°äºç­‰äº6çš„æ—¶å€™å°±åŒ–ä¸ºé“¾è¡¨ã€‚

## æ­£æ–‡ 

> HashMapåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œé‚£ä½ ä¸€èˆ¬éƒ½æ˜¯æ€ä¹ˆå¤„ç†è¿™ç§æƒ…å†µçš„ï¼Ÿ

ä¸€èˆ¬åœ¨å¤šçº¿ç¨‹çš„åœºæ™¯ï¼Œæœ‰å¥½å‡ ç§ä¸åŒçš„æ–¹å¼å»ä»£æ›¿ï¼š

- ä½¿ç”¨Collections.synchronizedMap(Map)åˆ›å»ºçº¿ç¨‹å®‰å…¨çš„mapé›†åˆï¼›
- Hashtable
- ConcurrentHashMap

ä¸è¿‡å‡ºäºçº¿ç¨‹å¹¶å‘åº¦çš„åŸå› ï¼Œæˆ‘éƒ½ä¼šèˆå¼ƒå‰ä¸¤è€…ä½¿ç”¨æœ€åçš„ConcurrentHashMapï¼Œä»–çš„æ€§èƒ½å’Œæ•ˆç‡æ˜æ˜¾é«˜äºå‰ä¸¤è€…ã€‚

> Collections.synchronizedMapæ˜¯æ€ä¹ˆå®ç°çº¿ç¨‹å®‰å…¨çš„ä½ æœ‰äº†è§£è¿‡ä¹ˆï¼Ÿ

åœ¨SynchronizedMapå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªæ™®é€šå¯¹è±¡Mapï¼Œè¿˜æœ‰æ’æ–¥é”mutexï¼Œå¦‚å›¾

![img](../images/chp01.webp)

```
Collections.synchronizedMap(new HashMap<>(16));
```

æˆ‘ä»¬åœ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™å°±éœ€è¦ä¼ å…¥ä¸€ä¸ªMapï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªæ„é€ å™¨ï¼Œå¦‚æœä½ ä¼ å…¥äº†mutexå‚æ•°ï¼Œåˆ™å°†å¯¹è±¡æ’æ–¥é”èµ‹å€¼ä¸ºä¼ å…¥çš„å¯¹è±¡ã€‚

å¦‚æœæ²¡æœ‰ï¼Œåˆ™å°†å¯¹è±¡æ’æ–¥é”èµ‹å€¼ä¸ºthisï¼Œå³è°ƒç”¨synchronizedMapçš„å¯¹è±¡ï¼Œå°±æ˜¯ä¸Šé¢çš„Mapã€‚

åˆ›å»ºå‡ºsynchronizedMapä¹‹åï¼Œå†æ“ä½œmapçš„æ—¶å€™ï¼Œå°±ä¼šå¯¹æ–¹æ³•ä¸Šé”ï¼Œå¦‚å›¾å…¨æ˜¯ğŸ”

![img](../images/chp02.webp)

> å›ç­”å¾—ä¸é”™ï¼Œèƒ½è·Ÿæˆ‘èŠä¸€ä¸‹Hashtableä¹ˆï¼Ÿ

è·ŸHashMapç›¸æ¯”Hashtableæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé€‚åˆåœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼Œä½†æ˜¯æ•ˆç‡å¯ä¸å¤ªä¹è§‚ã€‚

> ä½ èƒ½è¯´è¯´ä»–æ•ˆç‡ä½çš„åŸå› ä¹ˆï¼Ÿ

æˆ‘çœ‹è¿‡ä»–çš„æºç ï¼Œä»–åœ¨å¯¹æ•°æ®æ“ä½œçš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œæ‰€ä»¥æ•ˆç‡æ¯”è¾ƒä½ä¸‹ã€‚

![img](../images/chp03.webp)

> é™¤äº†è¿™ä¸ªä½ è¿˜èƒ½è¯´å‡ºä¸€äº›Hashtable è·ŸHashMapä¸ä¸€æ ·ç‚¹ä¹ˆï¼Ÿ

Hashtable æ˜¯ä¸å…è®¸é”®æˆ–å€¼ä¸º null çš„ï¼ŒHashMap çš„é”®å€¼åˆ™éƒ½å¯ä»¥ä¸º nullã€‚

> ä¸ºä»€ä¹ˆ Hashtable æ˜¯ä¸å…è®¸ KEY å’Œ VALUE ä¸º null, è€Œ HashMap åˆ™å¯ä»¥å‘¢ï¼Ÿ

å› ä¸ºHashtableåœ¨æˆ‘ä»¬put ç©ºå€¼çš„æ—¶å€™ä¼šç›´æ¥æŠ›ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œä½†æ˜¯HashMapå´åšäº†ç‰¹æ®Šå¤„ç†ã€‚

```
static final int hash(Object key) {
    int h;
    return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
}
```

> ä½†æ˜¯ä½ è¿˜æ˜¯æ²¡è¯´ä¸ºå•¥Hashtable æ˜¯ä¸å…è®¸é”®æˆ–å€¼ä¸º null çš„ï¼ŒHashMap çš„é”®å€¼åˆ™éƒ½å¯ä»¥ä¸º nullï¼Ÿ

è¿™æ˜¯å› ä¸ºHashtableä½¿ç”¨çš„æ˜¯**å®‰å…¨å¤±è´¥æœºåˆ¶ï¼ˆfail-safeï¼‰**ï¼Œè¿™ç§æœºåˆ¶ä¼šä½¿ä½ æ­¤æ¬¡è¯»åˆ°çš„æ•°æ®ä¸ä¸€å®šæ˜¯æœ€æ–°çš„æ•°æ®ã€‚

å¦‚æœä½ ä½¿ç”¨nullå€¼ï¼Œå°±ä¼šä½¿å¾—å…¶æ— æ³•åˆ¤æ–­å¯¹åº”çš„keyæ˜¯ä¸å­˜åœ¨è¿˜æ˜¯ä¸ºç©ºï¼Œå› ä¸ºä½ æ— æ³•å†è°ƒç”¨ä¸€æ¬¡contain(keyï¼‰æ¥å¯¹keyæ˜¯å¦å­˜åœ¨è¿›è¡Œåˆ¤æ–­ï¼ŒConcurrentHashMapåŒç†ã€‚

> å¥½çš„ä½ ç»§ç»­è¯´ä¸åŒç‚¹å§ã€‚

- **å®ç°æ–¹å¼ä¸åŒ**ï¼šHashtable ç»§æ‰¿äº† Dictionaryç±»ï¼Œè€Œ HashMap ç»§æ‰¿çš„æ˜¯ AbstractMap ç±»ã€‚

  Dictionary æ˜¯ JDK 1.0 æ·»åŠ çš„ï¼Œè²Œä¼¼æ²¡äººç”¨è¿‡è¿™ä¸ªï¼Œæˆ‘ä¹Ÿæ²¡ç”¨è¿‡ã€‚

- **åˆå§‹åŒ–å®¹é‡ä¸åŒ**ï¼šHashMap çš„åˆå§‹å®¹é‡ä¸ºï¼š16ï¼ŒHashtable åˆå§‹å®¹é‡ä¸ºï¼š11ï¼Œä¸¤è€…çš„è´Ÿè½½å› å­é»˜è®¤éƒ½æ˜¯ï¼š0.75ã€‚

- **æ‰©å®¹æœºåˆ¶ä¸åŒ**ï¼šå½“ç°æœ‰å®¹é‡å¤§äºæ€»å®¹é‡ * è´Ÿè½½å› å­æ—¶ï¼ŒHashMap æ‰©å®¹è§„åˆ™ä¸ºå½“å‰å®¹é‡ç¿»å€ï¼ŒHashtable æ‰©å®¹è§„åˆ™ä¸ºå½“å‰å®¹é‡ç¿»å€ + 1ã€‚

- **è¿­ä»£å™¨ä¸åŒ**ï¼šHashMap ä¸­çš„ Iterator è¿­ä»£å™¨æ˜¯ fail-fast çš„ï¼Œè€Œ Hashtable çš„ Enumerator ä¸æ˜¯ fail-fast çš„ã€‚

  æ‰€ä»¥ï¼Œå½“å…¶ä»–çº¿ç¨‹æ”¹å˜äº†HashMap çš„ç»“æ„ï¼Œå¦‚ï¼šå¢åŠ ã€åˆ é™¤å…ƒç´ ï¼Œå°†ä¼šæŠ›å‡ºConcurrentModificationException å¼‚å¸¸ï¼Œè€Œ Hashtable åˆ™ä¸ä¼šã€‚

> fail-fastæ˜¯å•¥ï¼Ÿ

**å¿«é€Ÿå¤±è´¥-failâ€”fast**æ˜¯javaé›†åˆä¸­çš„ä¸€ç§æœºåˆ¶ï¼Œ åœ¨ç”¨è¿­ä»£å™¨éå†ä¸€ä¸ªé›†åˆå¯¹è±¡æ—¶ï¼Œå¦‚æœéå†è¿‡ç¨‹ä¸­å¯¹é›†åˆå¯¹è±¡çš„å†…å®¹è¿›è¡Œäº†ä¿®æ”¹ï¼ˆå¢åŠ ã€åˆ é™¤ã€ä¿®æ”¹ï¼‰ï¼Œåˆ™ä¼šæŠ›å‡ºConcurrent Modification Exceptionã€‚

> ä»–çš„åŸç†æ˜¯å•¥ï¼Ÿ

è¿­ä»£å™¨åœ¨éå†æ—¶ç›´æ¥è®¿é—®é›†åˆä¸­çš„å†…å®¹ï¼Œå¹¶ä¸”åœ¨éå†è¿‡ç¨‹ä¸­ä½¿ç”¨ä¸€ä¸ª modCount å˜é‡ã€‚

é›†åˆåœ¨è¢«éå†æœŸé—´å¦‚æœå†…å®¹å‘ç”Ÿå˜åŒ–ï¼Œå°±ä¼šæ”¹å˜modCountçš„å€¼ã€‚

æ¯å½“è¿­ä»£å™¨ä½¿ç”¨hashNext()/next()éå†ä¸‹ä¸€ä¸ªå…ƒç´ ä¹‹å‰ï¼Œéƒ½ä¼šæ£€æµ‹modCountå˜é‡æ˜¯å¦ä¸ºexpectedmodCountå€¼ï¼Œæ˜¯çš„è¯å°±è¿”å›éå†ï¼›å¦åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œç»ˆæ­¢éå†ã€‚

**Tip**ï¼šè¿™é‡Œå¼‚å¸¸çš„æŠ›å‡ºæ¡ä»¶æ˜¯æ£€æµ‹åˆ° modCountï¼=expectedmodCount è¿™ä¸ªæ¡ä»¶ã€‚å¦‚æœé›†åˆå‘ç”Ÿå˜åŒ–æ—¶ä¿®æ”¹modCountå€¼åˆšå¥½åˆè®¾ç½®ä¸ºäº†expectedmodCountå€¼ï¼Œåˆ™å¼‚å¸¸ä¸ä¼šæŠ›å‡ºã€‚

å› æ­¤ï¼Œä¸èƒ½ä¾èµ–äºè¿™ä¸ªå¼‚å¸¸æ˜¯å¦æŠ›å‡ºè€Œè¿›è¡Œå¹¶å‘æ“ä½œçš„ç¼–ç¨‹ï¼Œè¿™ä¸ªå¼‚å¸¸åªå»ºè®®ç”¨äºæ£€æµ‹å¹¶å‘ä¿®æ”¹çš„bugã€‚

> è¯´è¯´ä»–çš„åœºæ™¯ï¼Ÿ

java.utilåŒ…ä¸‹çš„é›†åˆç±»éƒ½æ˜¯å¿«é€Ÿå¤±è´¥çš„ï¼Œä¸èƒ½åœ¨å¤šçº¿ç¨‹ä¸‹å‘ç”Ÿå¹¶å‘ä¿®æ”¹ï¼ˆè¿­ä»£è¿‡ç¨‹ä¸­è¢«ä¿®æ”¹ï¼‰ç®—æ˜¯ä¸€ç§å®‰å…¨æœºåˆ¶å§ã€‚

**Tip**ï¼š**å®‰å…¨å¤±è´¥ï¼ˆfailâ€”safeï¼‰**å¤§å®¶ä¹Ÿå¯ä»¥äº†è§£ä¸‹ï¼Œjava.util.concurrentåŒ…ä¸‹çš„å®¹å™¨éƒ½æ˜¯å®‰å…¨å¤±è´¥ï¼Œå¯ä»¥åœ¨å¤šçº¿ç¨‹ä¸‹å¹¶å‘ä½¿ç”¨ï¼Œå¹¶å‘ä¿®æ”¹ã€‚

> éƒ½è¯´äº†ä»–çš„å¹¶å‘åº¦ä¸å¤Ÿï¼Œæ€§èƒ½å¾ˆä½ï¼Œè¿™ä¸ªæ—¶å€™ä½ éƒ½æ€ä¹ˆå¤„ç†çš„ï¼Ÿ

è¿™æ ·çš„åœºæ™¯ï¼Œæˆ‘ä»¬åœ¨å¼€å‘è¿‡ç¨‹ä¸­éƒ½æ˜¯ä½¿ç”¨ConcurrentHashMapï¼Œä»–çš„å¹¶å‘çš„ç›¸æ¯”å‰ä¸¤è€…å¥½å¾ˆå¤šã€‚

> é‚£ä½ è·Ÿæˆ‘è¯´è¯´ä»–çš„æ•°æ®ç»“æ„å§ï¼Œä»¥åŠä¸ºå•¥ä»–å¹¶å‘åº¦è¿™ä¹ˆé«˜ï¼Ÿ

HashMap åº•å±‚æ˜¯åŸºäº `æ•°ç»„ + é“¾è¡¨` ç»„æˆçš„ï¼Œä¸è¿‡åœ¨ jdk1.7 å’Œ 1.8 ä¸­å…·ä½“å®ç°ç¨æœ‰ä¸åŒã€‚

æˆ‘å…ˆè¯´ä¸€ä¸‹ä»–åœ¨1.7ä¸­çš„æ•°æ®ç»“æ„å§ï¼š

![img](../images/chp04.webp)

å¦‚å›¾æ‰€ç¤ºï¼Œæ˜¯ç”± Segment æ•°ç»„ã€HashEntry ç»„æˆï¼Œå’Œ HashMap ä¸€æ ·ï¼Œä»ç„¶æ˜¯**æ•°ç»„åŠ é“¾è¡¨**ã€‚

Segment æ˜¯ ConcurrentHashMap çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œä¸»è¦çš„ç»„æˆå¦‚ä¸‹ï¼š

```
static final class Segment<K,V> extends ReentrantLock implements Serializable {

    private static final long serialVersionUID = 2249069246763182397L;

    // å’Œ HashMap ä¸­çš„ HashEntry ä½œç”¨ä¸€æ ·ï¼ŒçœŸæ­£å­˜æ”¾æ•°æ®çš„æ¡¶
    transient volatile HashEntry<K,V>[] table;

    transient int count;
        // è®°å¾—å¿«é€Ÿå¤±è´¥ï¼ˆfailâ€”fastï¼‰ä¹ˆï¼Ÿ
    transient int modCount;
        // å¤§å°
    transient int threshold;
        // è´Ÿè½½å› å­
    final float loadFactor;

}
```

HashEntryè·ŸHashMapå·®ä¸å¤šçš„ï¼Œä½†æ˜¯ä¸åŒç‚¹æ˜¯ï¼Œä»–ä½¿ç”¨volatileå»ä¿®é¥°äº†ä»–çš„æ•°æ®Valueè¿˜æœ‰ä¸‹ä¸€ä¸ªèŠ‚ç‚¹nextã€‚

> volatileçš„ç‰¹æ€§æ˜¯å•¥ï¼Ÿ

- ä¿è¯äº†ä¸åŒçº¿ç¨‹å¯¹è¿™ä¸ªå˜é‡è¿›è¡Œæ“ä½œæ—¶çš„å¯è§æ€§ï¼Œå³ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†æŸä¸ªå˜é‡çš„å€¼ï¼Œè¿™æ–°å€¼å¯¹å…¶ä»–çº¿ç¨‹æ¥è¯´æ˜¯ç«‹å³å¯è§çš„ã€‚ï¼ˆå®ç°**å¯è§æ€§**ï¼‰
- ç¦æ­¢è¿›è¡ŒæŒ‡ä»¤é‡æ’åºã€‚ï¼ˆå®ç°**æœ‰åºæ€§**ï¼‰
- volatile åªèƒ½ä¿è¯å¯¹å•æ¬¡è¯»/å†™çš„åŸå­æ€§ã€‚i++ è¿™ç§æ“ä½œä¸èƒ½ä¿è¯**åŸå­æ€§**ã€‚

> é‚£ä½ èƒ½è¯´è¯´ä»–å¹¶å‘åº¦é«˜çš„åŸå› ä¹ˆï¼Ÿ

åŸç†ä¸Šæ¥è¯´ï¼ŒConcurrentHashMap é‡‡ç”¨äº†**åˆ†æ®µé”**æŠ€æœ¯ï¼Œå…¶ä¸­ Segment ç»§æ‰¿äº ReentrantLockã€‚

ä¸ä¼šåƒ HashTable é‚£æ ·ä¸ç®¡æ˜¯ put è¿˜æ˜¯ get æ“ä½œéƒ½éœ€è¦åšåŒæ­¥å¤„ç†ï¼Œç†è®ºä¸Š ConcurrentHashMap æ”¯æŒ CurrencyLevel (Segment æ•°ç»„æ•°é‡)çš„çº¿ç¨‹å¹¶å‘ã€‚

æ¯å½“ä¸€ä¸ªçº¿ç¨‹å ç”¨é”è®¿é—®ä¸€ä¸ª Segment æ—¶ï¼Œä¸ä¼šå½±å“åˆ°å…¶ä»–çš„ Segmentã€‚

å°±æ˜¯è¯´å¦‚æœå®¹é‡å¤§å°æ˜¯16ä»–çš„å¹¶å‘åº¦å°±æ˜¯16ï¼Œå¯ä»¥åŒæ—¶å…è®¸16ä¸ªçº¿ç¨‹æ“ä½œ16ä¸ªSegmentè€Œä¸”è¿˜æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

```
public V put(K key, V value) {
    Segment<K,V> s;
    if (value == null)
        throw new NullPointerException();//è¿™å°±æ˜¯ä¸ºå•¥ä»–ä¸å¯ä»¥put nullå€¼çš„åŸå› 
    int hash = hash(key);
    int j = (hash >>> segmentShift) & segmentMask;
    if ((s = (Segment<K,V>)UNSAFE.getObject          
         (segments, (j << SSHIFT) + SBASE)) == null) 
        s = ensureSegment(j);
    return s.put(key, hash, value, false);
}
```

ä»–å…ˆå®šä½åˆ°Segmentï¼Œç„¶åå†è¿›è¡Œputæ“ä½œã€‚

æˆ‘ä»¬çœ‹çœ‹ä»–çš„putæºä»£ç ï¼Œä½ å°±çŸ¥é“ä»–æ˜¯æ€ä¹ˆåšåˆ°çº¿ç¨‹å®‰å…¨çš„äº†ï¼Œå…³é”®å¥å­æˆ‘æ³¨é‡Šäº†ã€‚

```
        final V put(K key, int hash, V value, boolean onlyIfAbsent) {
          // å°†å½“å‰ Segment ä¸­çš„ table é€šè¿‡ key çš„ hashcode å®šä½åˆ° HashEntry
            HashEntry<K,V> node = tryLock() ? null :
                scanAndLockForPut(key, hash, value);
            V oldValue;
            try {
                HashEntry<K,V>[] tab = table;
                int index = (tab.length - 1) & hash;
                HashEntry<K,V> first = entryAt(tab, index);
                for (HashEntry<K,V> e = first;;) {
                    if (e != null) {
                        K k;
 // éå†è¯¥ HashEntryï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™åˆ¤æ–­ä¼ å…¥çš„ key å’Œå½“å‰éå†çš„ key æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰åˆ™è¦†ç›–æ—§çš„ valueã€‚
                        if ((k = e.key) == key ||
                            (e.hash == hash && key.equals(k))) {
                            oldValue = e.value;
                            if (!onlyIfAbsent) {
                                e.value = value;
                                ++modCount;
                            }
                            break;
                        }
                        e = e.next;
                    }
                    else {
                 // ä¸ä¸ºç©ºåˆ™éœ€è¦æ–°å»ºä¸€ä¸ª HashEntry å¹¶åŠ å…¥åˆ° Segment ä¸­ï¼ŒåŒæ—¶ä¼šå…ˆåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ã€‚
                        if (node != null)
                            node.setNext(first);
                        else
                            node = new HashEntry<K,V>(hash, key, value, first);
                        int c = count + 1;
                        if (c > threshold && tab.length < MAXIMUM_CAPACITY)
                            rehash(node);
                        else
                            setEntryAt(tab, index, node);
                        ++modCount;
                        count = c;
                        oldValue = null;
                        break;
                    }
                }
            } finally {
               //é‡Šæ”¾é”
                unlock();
            }
            return oldValue;
        }
```

é¦–å…ˆç¬¬ä¸€æ­¥çš„æ—¶å€™ä¼šå°è¯•è·å–é”ï¼Œå¦‚æœè·å–å¤±è´¥è‚¯å®šå°±æœ‰å…¶ä»–çº¿ç¨‹å­˜åœ¨ç«äº‰ï¼Œåˆ™åˆ©ç”¨ `scanAndLockForPut()` è‡ªæ—‹è·å–é”ã€‚

1. å°è¯•è‡ªæ—‹è·å–é”ã€‚
2. å¦‚æœé‡è¯•çš„æ¬¡æ•°è¾¾åˆ°äº† `MAX_SCAN_RETRIES` åˆ™æ”¹ä¸ºé˜»å¡é”è·å–ï¼Œä¿è¯èƒ½è·å–æˆåŠŸã€‚

> é‚£ä»–getçš„é€»è¾‘å‘¢ï¼Ÿ

get é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦å°† Key é€šè¿‡ Hash ä¹‹åå®šä½åˆ°å…·ä½“çš„ Segment ï¼Œå†é€šè¿‡ä¸€æ¬¡ Hash å®šä½åˆ°å…·ä½“çš„å…ƒç´ ä¸Šã€‚

ç”±äº HashEntry ä¸­çš„ value å±æ€§æ˜¯ç”¨ volatile å…³é”®è¯ä¿®é¥°çš„ï¼Œä¿è¯äº†å†…å­˜å¯è§æ€§ï¼Œæ‰€ä»¥æ¯æ¬¡è·å–æ—¶éƒ½æ˜¯æœ€æ–°å€¼ã€‚

ConcurrentHashMap çš„ get æ–¹æ³•æ˜¯éå¸¸é«˜æ•ˆçš„ï¼Œ**å› ä¸ºæ•´ä¸ªè¿‡ç¨‹éƒ½ä¸éœ€è¦åŠ é”**ã€‚

> ä½ æœ‰æ²¡æœ‰å‘ç°1.7è™½ç„¶å¯ä»¥æ”¯æŒæ¯ä¸ªSegmentå¹¶å‘è®¿é—®ï¼Œä½†æ˜¯è¿˜æ˜¯å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Ÿ

æ˜¯çš„ï¼Œå› ä¸ºåŸºæœ¬ä¸Šè¿˜æ˜¯æ•°ç»„åŠ é“¾è¡¨çš„æ–¹å¼ï¼Œæˆ‘ä»¬å»æŸ¥è¯¢çš„æ—¶å€™ï¼Œè¿˜å¾—éå†é“¾è¡¨ï¼Œä¼šå¯¼è‡´æ•ˆç‡å¾ˆä½ï¼Œè¿™ä¸ªè·Ÿjdk1.7çš„HashMapæ˜¯å­˜åœ¨çš„ä¸€æ ·é—®é¢˜ï¼Œæ‰€ä»¥ä»–åœ¨jdk1.8å®Œå…¨ä¼˜åŒ–äº†ã€‚

> é‚£ä½ å†è·Ÿæˆ‘èŠèŠjdk1.8ä»–çš„æ•°æ®ç»“æ„æ˜¯æ€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿ

å…¶ä¸­æŠ›å¼ƒäº†åŸæœ‰çš„ Segment åˆ†æ®µé”ï¼Œè€Œé‡‡ç”¨äº† `CAS + synchronized` æ¥ä¿è¯å¹¶å‘å®‰å…¨æ€§ã€‚

è·ŸHashMapå¾ˆåƒï¼Œä¹ŸæŠŠä¹‹å‰çš„HashEntryæ”¹æˆäº†Nodeï¼Œä½†æ˜¯ä½œç”¨ä¸å˜ï¼ŒæŠŠå€¼å’Œnexté‡‡ç”¨äº†volatileå»ä¿®é¥°ï¼Œä¿è¯äº†å¯è§æ€§ï¼Œå¹¶ä¸”ä¹Ÿå¼•å…¥äº†çº¢é»‘æ ‘ï¼Œåœ¨é“¾è¡¨å¤§äºä¸€å®šå€¼çš„æ—¶å€™ä¼šè½¬æ¢ï¼ˆé»˜è®¤æ˜¯8ï¼‰ã€‚

> åŒæ ·çš„ï¼Œä½ èƒ½è·Ÿæˆ‘èŠä¸€ä¸‹ä»–å€¼çš„å­˜å–æ“ä½œä¹ˆï¼Ÿä»¥åŠæ˜¯æ€ä¹ˆä¿è¯çº¿ç¨‹å®‰å…¨çš„ï¼Ÿ

ConcurrentHashMapåœ¨è¿›è¡Œputæ“ä½œçš„è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š

1. æ ¹æ® key è®¡ç®—å‡º hashcode ã€‚
2. åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œåˆå§‹åŒ–ã€‚
3. å³ä¸ºå½“å‰ key å®šä½å‡ºçš„ Nodeï¼Œå¦‚æœä¸ºç©ºè¡¨ç¤ºå½“å‰ä½ç½®å¯ä»¥å†™å…¥æ•°æ®ï¼Œåˆ©ç”¨ CAS å°è¯•å†™å…¥ï¼Œå¤±è´¥åˆ™è‡ªæ—‹ä¿è¯æˆåŠŸã€‚
4. å¦‚æœå½“å‰ä½ç½®çš„ `hashcode == MOVED == -1`,åˆ™éœ€è¦è¿›è¡Œæ‰©å®¹ã€‚
5. å¦‚æœéƒ½ä¸æ»¡è¶³ï¼Œåˆ™åˆ©ç”¨ synchronized é”å†™å…¥æ•°æ®ã€‚
6. å¦‚æœæ•°é‡å¤§äº `TREEIFY_THRESHOLD` åˆ™è¦è½¬æ¢ä¸ºçº¢é»‘æ ‘ã€‚

![img](../images/chp05.webp)

> ä½ åœ¨ä¸Šé¢æåˆ°CASæ˜¯ä»€ä¹ˆï¼Ÿè‡ªæ—‹åˆæ˜¯ä»€ä¹ˆï¼Ÿ

CAS æ˜¯ä¹è§‚é”çš„ä¸€ç§å®ç°æ–¹å¼ï¼Œæ˜¯ä¸€ç§è½»é‡çº§é”ï¼ŒJUC ä¸­å¾ˆå¤šå·¥å…·ç±»çš„å®ç°å°±æ˜¯åŸºäº CAS çš„ã€‚

CAS æ“ä½œçš„æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçº¿ç¨‹åœ¨è¯»å–æ•°æ®æ—¶ä¸è¿›è¡ŒåŠ é”ï¼Œåœ¨å‡†å¤‡å†™å›æ•°æ®æ—¶ï¼Œæ¯”è¾ƒåŸå€¼æ˜¯å¦ä¿®æ”¹ï¼Œè‹¥æœªè¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹åˆ™å†™å›ï¼Œè‹¥å·²è¢«ä¿®æ”¹ï¼Œåˆ™é‡æ–°æ‰§è¡Œè¯»å–æµç¨‹ã€‚

è¿™æ˜¯ä¸€ç§ä¹è§‚ç­–ç•¥ï¼Œè®¤ä¸ºå¹¶å‘æ“ä½œå¹¶ä¸æ€»ä¼šå‘ç”Ÿã€‚

![img](../images/chp06.webp)

å°±æ¯”å¦‚æˆ‘ç°åœ¨è¦ä¿®æ”¹æ•°æ®åº“çš„ä¸€æ¡æ•°æ®ï¼Œä¿®æ”¹ä¹‹å‰æˆ‘å…ˆæ‹¿åˆ°ä»–åŸæ¥çš„å€¼ï¼Œç„¶ååœ¨SQLé‡Œé¢è¿˜ä¼šåŠ ä¸ªåˆ¤æ–­ï¼ŒåŸæ¥çš„å€¼å’Œæˆ‘æ‰‹ä¸Šæ‹¿åˆ°çš„ä»–çš„åŸæ¥çš„å€¼æ˜¯å¦ä¸€æ ·ï¼Œä¸€æ ·æˆ‘ä»¬å°±å¯ä»¥å»ä¿®æ”¹äº†ï¼Œä¸ä¸€æ ·å°±è¯æ˜è¢«åˆ«çš„çº¿ç¨‹ä¿®æ”¹äº†ä½ å°±returné”™è¯¯å°±å¥½äº†ã€‚

SQLä¼ªä»£ç å¤§æ¦‚å¦‚ä¸‹ï¼š

```
update a set value = newValue where value = #{oldValue}//oldValueå°±æ˜¯æˆ‘ä»¬æ‰§è¡Œå‰æŸ¥è¯¢å‡ºæ¥çš„å€¼ 
```

> CASå°±ä¸€å®šèƒ½ä¿è¯æ•°æ®æ²¡è¢«åˆ«çš„çº¿ç¨‹ä¿®æ”¹è¿‡ä¹ˆï¼Ÿ

å¹¶ä¸æ˜¯çš„ï¼Œæ¯”å¦‚å¾ˆç»å…¸çš„ABAé—®é¢˜ï¼ŒCASå°±æ— æ³•åˆ¤æ–­äº†ã€‚

> ä»€ä¹ˆæ˜¯ABAï¼Ÿ

å°±æ˜¯è¯´æ¥äº†ä¸€ä¸ªçº¿ç¨‹æŠŠå€¼æ”¹å›äº†Bï¼Œåˆæ¥äº†ä¸€ä¸ªçº¿ç¨‹æŠŠå€¼åˆæ”¹å›äº†Aï¼Œå¯¹äºè¿™ä¸ªæ—¶å€™åˆ¤æ–­çš„çº¿ç¨‹ï¼Œå°±å‘ç°ä»–çš„å€¼è¿˜æ˜¯Aï¼Œæ‰€ä»¥ä»–å°±ä¸çŸ¥é“è¿™ä¸ªå€¼åˆ°åº•æœ‰æ²¡æœ‰è¢«äººæ”¹è¿‡ï¼Œå…¶å®å¾ˆå¤šåœºæ™¯å¦‚æœåªè¿½æ±‚æœ€åç»“æœæ­£ç¡®ï¼Œè¿™æ˜¯æ²¡å…³ç³»çš„ã€‚

ä½†æ˜¯å®é™…è¿‡ç¨‹ä¸­è¿˜æ˜¯éœ€è¦è®°å½•ä¿®æ”¹è¿‡ç¨‹çš„ï¼Œæ¯”å¦‚èµ„é‡‘ä¿®æ”¹ä»€ä¹ˆçš„ï¼Œä½ æ¯æ¬¡ä¿®æ”¹çš„éƒ½åº”è¯¥æœ‰è®°å½•ï¼Œæ–¹ä¾¿å›æº¯ã€‚

> é‚£æ€ä¹ˆè§£å†³ABAé—®é¢˜ï¼Ÿ

ç”¨ç‰ˆæœ¬å·å»ä¿è¯å°±å¥½äº†ï¼Œå°±æ¯”å¦‚è¯´ï¼Œæˆ‘åœ¨ä¿®æ”¹å‰å»æŸ¥è¯¢ä»–åŸæ¥çš„å€¼çš„æ—¶å€™å†å¸¦ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œæ¯æ¬¡åˆ¤æ–­å°±è¿å€¼å’Œç‰ˆæœ¬å·ä¸€èµ·åˆ¤æ–­ï¼Œåˆ¤æ–­æˆåŠŸå°±ç»™ç‰ˆæœ¬å·åŠ 1ã€‚

```
update a set value = newValue ï¼Œvision = vision + 1 where value = #{oldValue} and vision = #{vision} // åˆ¤æ–­åŸæ¥çš„å€¼å’Œç‰ˆæœ¬å·æ˜¯å¦åŒ¹é…ï¼Œä¸­é—´æœ‰åˆ«çš„çº¿ç¨‹ä¿®æ”¹ï¼Œå€¼å¯èƒ½ç›¸ç­‰ï¼Œä½†æ˜¯ç‰ˆæœ¬å·100%ä¸ä¸€æ ·
```

> æœ‰ç‚¹ä¸œè¥¿ï¼Œé™¤äº†ç‰ˆæœ¬å·è¿˜æœ‰åˆ«çš„æ–¹æ³•ä¿è¯ä¹ˆï¼Ÿ

å…¶å®æœ‰å¾ˆå¤šæ–¹å¼ï¼Œæ¯”å¦‚æ—¶é—´æˆ³ä¹Ÿå¯ä»¥ï¼ŒæŸ¥è¯¢çš„æ—¶å€™æŠŠæ—¶é—´æˆ³ä¸€èµ·æŸ¥å‡ºæ¥ï¼Œå¯¹çš„ä¸Šæ‰ä¿®æ”¹å¹¶ä¸”æ›´æ–°å€¼çš„æ—¶å€™ä¸€èµ·ä¿®æ”¹æ›´æ–°æ—¶é—´ï¼Œè¿™æ ·ä¹Ÿèƒ½ä¿è¯ï¼Œæ–¹æ³•å¾ˆå¤šä½†æ˜¯è·Ÿç‰ˆæœ¬å·éƒ½æ˜¯å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼Œçœ‹åœºæ™¯å¤§å®¶æƒ³æ€ä¹ˆè®¾è®¡å§ã€‚

> CASæ€§èƒ½å¾ˆé«˜ï¼Œä½†æ˜¯æˆ‘çŸ¥é“synchronizedæ€§èƒ½å¯ä¸å’‹åœ°ï¼Œä¸ºå•¥jdk1.8å‡çº§ä¹‹ååè€Œå¤šäº†synchronizedï¼Ÿ

synchronizedä¹‹å‰ä¸€ç›´éƒ½æ˜¯é‡é‡çº§çš„é”ï¼Œä½†æ˜¯åæ¥javaå®˜æ–¹æ˜¯å¯¹ä»–è¿›è¡Œè¿‡å‡çº§çš„ï¼Œä»–ç°åœ¨é‡‡ç”¨çš„æ˜¯é”å‡çº§çš„æ–¹å¼å»åšçš„ã€‚

é’ˆå¯¹ synchronized è·å–é”çš„æ–¹å¼ï¼ŒJVM ä½¿ç”¨äº†é”å‡çº§çš„ä¼˜åŒ–æ–¹å¼ï¼Œå°±æ˜¯å…ˆä½¿ç”¨**åå‘é”**ä¼˜å…ˆåŒä¸€çº¿ç¨‹ç„¶åå†æ¬¡è·å–é”ï¼Œå¦‚æœå¤±è´¥ï¼Œå°±å‡çº§ä¸º **CAS è½»é‡çº§é”**ï¼Œå¦‚æœå¤±è´¥å°±ä¼šçŸ­æš‚**è‡ªæ—‹**ï¼Œé˜²æ­¢çº¿ç¨‹è¢«ç³»ç»ŸæŒ‚èµ·ã€‚æœ€åå¦‚æœä»¥ä¸Šéƒ½å¤±è´¥å°±å‡çº§ä¸º**é‡é‡çº§é”**ã€‚

æ‰€ä»¥æ˜¯ä¸€æ­¥æ­¥å‡çº§ä¸Šå»çš„ï¼Œæœ€åˆä¹Ÿæ˜¯é€šè¿‡å¾ˆå¤šè½»é‡çº§çš„æ–¹å¼é”å®šçš„ã€‚

> ğŸ‚é‚£æˆ‘ä»¬å›å½’æ­£é¢˜ï¼ŒConcurrentHashMapçš„getæ“ä½œåˆæ˜¯æ€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿ

- æ ¹æ®è®¡ç®—å‡ºæ¥çš„ hashcode å¯»å€ï¼Œå¦‚æœå°±åœ¨æ¡¶ä¸Šé‚£ä¹ˆç›´æ¥è¿”å›å€¼ã€‚
- å¦‚æœæ˜¯çº¢é»‘æ ‘é‚£å°±æŒ‰ç…§æ ‘çš„æ–¹å¼è·å–å€¼ã€‚
- å°±ä¸æ»¡è¶³é‚£å°±æŒ‰ç…§é“¾è¡¨çš„æ–¹å¼éå†è·å–å€¼ã€‚

![img](../images/chp07.webp)

å°ç»“ï¼š1.8 åœ¨ 1.7 çš„æ•°æ®ç»“æ„ä¸Šåšäº†å¤§çš„æ”¹åŠ¨ï¼Œé‡‡ç”¨çº¢é»‘æ ‘ä¹‹åå¯ä»¥ä¿è¯æŸ¥è¯¢æ•ˆç‡ï¼ˆ`O(logn)`ï¼‰ï¼Œç”šè‡³å–æ¶ˆäº† ReentrantLock æ”¹ä¸ºäº† synchronizedï¼Œè¿™æ ·å¯ä»¥çœ‹å‡ºåœ¨æ–°ç‰ˆçš„ JDK ä¸­å¯¹ synchronized ä¼˜åŒ–æ˜¯å¾ˆåˆ°ä½çš„ã€‚

## å¸¸è§é—®é¢˜ 

- è°ˆè°ˆä½ ç†è§£çš„ Hashtableï¼Œè®²è®²å…¶ä¸­çš„ get put è¿‡ç¨‹ã€‚ConcurrentHashMapåŒé—®ã€‚
- 1.8 åšäº†ä»€ä¹ˆä¼˜åŒ–ï¼Ÿ
- çº¿ç¨‹å®‰å…¨æ€ä¹ˆåšçš„ï¼Ÿ
- ä¸å®‰å…¨ä¼šå¯¼è‡´å“ªäº›é—®é¢˜ï¼Ÿ
- å¦‚ä½•è§£å†³ï¼Ÿæœ‰æ²¡æœ‰çº¿ç¨‹å®‰å…¨çš„å¹¶å‘å®¹å™¨ï¼Ÿ
- ConcurrentHashMap æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ
- ConcurrentHashMapå¹¶å‘åº¦ä¸ºå•¥å¥½è¿™ä¹ˆå¤šï¼Ÿ
- 1.7ã€1.8 å®ç°æœ‰ä½•ä¸åŒï¼Ÿä¸ºä»€ä¹ˆè¿™ä¹ˆåšï¼Ÿ
- CASæ˜¯å•¥ï¼Ÿ
- ABAæ˜¯å•¥ï¼Ÿåœºæ™¯æœ‰å“ªäº›ï¼Œæ€ä¹ˆè§£å†³ï¼Ÿ
- synchronizedåº•å±‚åŸç†æ˜¯å•¥ï¼Ÿ
- synchronizedé”å‡çº§ç­–ç•¥
- å¿«é€Ÿå¤±è´¥ï¼ˆfailâ€”fastï¼‰æ˜¯å•¥ï¼Œåº”ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿå®‰å…¨å¤±è´¥ï¼ˆfailâ€”safeï¼‰åŒé—®ã€‚